# Linux Threat Hunting Guide
## For RHEL and Ubuntu Systems

### Introduction
This guide provides systematic approaches and commands for threat hunting on Linux systems, specifically focusing on RHEL and Ubuntu distributions. It covers system analysis, log inspection, process monitoring, and network connection examination.

### System Baseline Analysis

#### User Activity and Authentication
```bash
# Review successful and failed login attempts
journalctl -u systemd-logind
last -f /var/log/wtmp
lastb -f /var/log/btmp

# Examine SSH access logs
grep "sshd" /var/log/auth.log    # Ubuntu
grep "sshd" /var/log/secure      # RHEL

# Check sudo usage
grep "sudo" /var/log/auth.log    # Ubuntu
grep "sudo" /var/log/secure      # RHEL
```

#### Process Analysis
```bash
# List all running processes with full details
ps auxf

# Check processes without TTY
ps aux | grep -v TTY

# Examine process trees for unusual parent-child relationships
pstree -p

# Monitor process creation in real-time
auditctl -w /bin -p x -k process_creation
ausearch -k process_creation
```

#### File System Analysis
```bash
# Find recently modified files
find / -type f -mtime -1 -ls

# Look for files with SUID/SGID bits
find / -type f \( -perm -4000 -o -perm -2000 \) -ls

# Check for hidden files and directories
find / -name ".*" -ls

# Monitor file system changes in real-time
auditctl -w /etc -p wa -k system_files
ausearch -k system_files
```

### Network Analysis

#### Connection Monitoring
```bash
# List all network connections
ss -tupln
netstat -tupln

# Monitor network connections in real-time
watch -n 1 'netstat -tupln'

# Check for listening ports
lsof -i -P -n | grep LISTEN
```

#### Suspicious Network Activity
```bash
# Check for unusual outbound connections
tcpdump -i any 'tcp[tcpflags] & (tcp-syn) != 0'

# Monitor DNS queries
tcpdump -i any 'udp port 53'

# Track connection attempts to common C2 ports
tcpdump 'tcp port 4444 or tcp port 5555'
```

### Memory Analysis

#### Memory Usage Inspection
```bash
# Check system memory usage
free -m
vmstat 1

# Monitor process memory usage
top -o %MEM
ps aux --sort=-%mem | head -n 10
```

#### Memory Dump Analysis
```bash
# Create memory dump of suspicious process
gcore -o memory_dump [PID]

# Use volatility for memory forensics (if installed)
volatility -f memory_dump.core linux_pslist
volatility -f memory_dump.core linux_netstat
```

### Common Indicators of Compromise (IoCs)

1. Unusual Process Behavior
   - High CPU/memory usage from unexpected processes
   - Processes running from temporary directories
   - Processes with randomized names
   - Unexpected child processes

2. Suspicious File Activity
   - Executables in /tmp or /var/tmp
   - Modified system binaries
   - Unexpected cronjobs
   - Hidden directories and files

3. Network Anomalies
   - Connections to unknown IP addresses
   - Unusual ports in LISTEN state
   - High volume of DNS queries
   - Unexpected outbound connections

### Response Actions

1. Immediate Containment
   ```bash
   # Kill suspicious process
   kill -9 [PID]
   
   # Block suspicious IP
   iptables -A INPUT -s [IP_ADDRESS] -j DROP
   
   # Disable user account
   usermod -L [USERNAME]
   ```

2. Evidence Collection
   ```bash
   # Capture process details
   ps auxf > process_snapshot.txt
   
   # Copy suspicious files
   cp -p [SUSPICIOUS_FILE] /evidence/
   
   # Create network capture
   tcpdump -w evidence.pcap -i any
   ```

### Regular Monitoring Tasks

#### Daily Checks
- Review authentication logs
- Check for new user accounts
- Monitor system resource usage
- Inspect network connections

#### Weekly Tasks
- Review installed packages
- Check for modified system files
- Analyze user login patterns
- Review sudo usage logs

### Distribution-Specific Notes

#### RHEL Systems
- Use `yum check-update` for package verification
- Monitor SELinux alerts in `/var/log/audit/audit.log`
- Check RPM package integrity with `rpm -Va`

#### Ubuntu Systems
- Use `apt list --installed` for package verification
- Monitor AppArmor events in `/var/log/kern.log`
- Check package integrity with `debsums`

### Additional Resources
- RHEL Security Guide: https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/index
- Ubuntu Security Guide: https://ubuntu.com/security/guides

### Linux Malware Indicators

#### Common Malware Characteristics
1. File System Indicators
   ```bash
   # Check for files with unusual permissions in /tmp
   find /tmp -type f -executable
   
   # Look for hidden directories with base64/hex names
   find / -type d -name ".[a-zA-Z0-9]*" -ls
   
   # Search for files with common malware extensions
   find / -type f \( -name "*.abc" -o -name "*.xmrig" -o -name "*.kinsing" \)
   ```

2. Process Indicators
   ```bash
   # Check for processes hiding with common names
   ps aux | grep -E "(kworker|crond|sshd|apache|nginx)" | grep -v grep
   
   # Look for processes running from unusual directories
   ps aux | awk '$11 ~ /^\/tmp|^\/var\/tmp|^\/dev\/shm/'
   
   # Monitor for crypto mining processes
   ps aux | grep -E "(monero|stratum|xmrig|cryptonight)"
   ```

3. Network Indicators
   ```bash
   # Check for connections to known mining pools
   netstat -ant | grep -E "(pool|mine|xmr|monero)"
   
   # Look for IRC connections (common in botnets)
   netstat -ant | grep ":6667"
   
   # Monitor for unusual DNS queries
   tcpdump -i any 'udp port 53' | grep -E "(\.cn$|\.ru$|\.bit$)"
   ```

### Advanced Log Analysis

#### Log Correlation Techniques
```bash
# Create timeline of auth attempts and process creation
awk '/sshd.*Failed|systemd.*COMMAND/' /var/log/auth.log /var/log/syslog | sort

# Correlate successful logins with file access
grep "session opened" /var/log/auth.log | \
  while read line; do
    user=$(echo $line | awk '{print $11}')
    time=$(echo $line | awk '{print $1,$2,$3}')
    find / -user $user -newermt "$time" -ls
  done
```

#### Advanced Log Queries
```bash
# Find rapid succession login attempts
awk '/Failed password/ {count[$11]++} END {for (ip in count) if (count[ip] > 10) print ip,count[ip]}' /var/log/auth.log

# Detect privilege escalation
awk '/sudo:.*COMMAND=/ {print $1,$2,$3,$6,$8,"Command="$(NF)}' /var/log/auth.log | sort | uniq -c

# Track file system changes
ausearch --start today --raw | \
  aureport --file --summary
```

#### Log Analysis Tools Integration
```bash
# Use LogWatch for daily report
logwatch --detail high --range today

# Configure custom LogWatch filters
cat > /etc/logwatch/conf/logfiles/custom.conf << EOF
LogFile = /var/log/custom.log
Archive = /var/log/custom.log.*
EOF
```

### Automated Monitoring Scripts

#### System Health Monitor
```bash
#!/bin/bash
# health_monitor.sh
# Monitors system health and sends alerts

THRESHOLD_CPU=90
THRESHOLD_MEM=90
ALERT_EMAIL="security@example.com"

while true; do
    # CPU Usage
    cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d. -f1)
    
    # Memory Usage
    mem_usage=$(free | grep Mem | awk '{print $3/$2 * 100.0}')
    
    # Disk Usage
    disk_usage=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
    
    if [ "$cpu_usage" -gt "$THRESHOLD_CPU" ] || \
       [ "$mem_usage" -gt "$THRESHOLD_MEM" ]; then
        echo "Alert: High resource usage detected" | \
        mail -s "System Alert" "$ALERT_EMAIL"
    fi
    
    sleep 300
done
```

#### Suspicious Process Monitor
```bash
#!/bin/bash
# process_monitor.sh
# Monitors for suspicious processes

SUSPICIOUS_PATHS=(/tmp /dev/shm /var/tmp)
LOG_FILE="/var/log/process_monitor.log"

check_suspicious_processes() {
    for path in "${SUSPICIOUS_PATHS[@]}"; do
        ps aux | awk -v path="$path" '$11 ~ path {print $1,$2,$11,$12}' >> "$LOG_FILE"
    done
}

while true; do
    check_suspicious_processes
    sleep 60
done
```

#### Network Connection Monitor
```bash
#!/bin/bash
# connection_monitor.sh
# Monitors for suspicious network connections

SUSPICIOUS_PORTS=(4444 5555 6666 6667 8080)
LOG_FILE="/var/log/connection_monitor.log"

monitor_connections() {
    for port in "${SUSPICIOUS_PORTS[@]}"; do
        netstat -ant | grep ":$port " >> "$LOG_FILE"
    done
    
    # Check for high number of concurrent connections
    netstat -ant | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | \
        awk '$1 > 100' >> "$LOG_FILE"
}

while true; do
    monitor_connections
    sleep 300
done
```

### Lynis Integration

#### Installation and Basic Usage
```bash
# Install Lynis
# For RHEL/CentOS
yum install lynis

# For Ubuntu
apt install lynis

# Run basic system audit
lynis audit system

# Generate detailed report
lynis audit system --quick > /var/log/lynis-report.txt
```

#### Custom Lynis Profiles
```bash
# Create custom profile
cat > /etc/lynis/custom.prf << EOF
# Skip specific tests
skip-test=BOOT-5122
skip-test=AUTH-9288

# Custom warning thresholds
warning=authentication
warning=filesystems
warning=storage
EOF

# Run audit with custom profile
lynis audit system --profile /etc/lynis/custom.prf
```

#### Automated Lynis Scanning
```bash
#!/bin/bash
# lynis_automated.sh
# Performs automated Lynis scans and reports changes

REPORT_DIR="/var/log/lynis-reports"
DATE=$(date +%Y-%m-%d)
REPORT="$REPORT_DIR/lynis-report-$DATE.txt"
DIFF_REPORT="$REPORT_DIR/lynis-diff-$DATE.txt"

# Run Lynis audit
lynis audit system --quick > "$REPORT"

# Compare with previous report
if [ -f "$REPORT_DIR/lynis-report-$(date -d "yesterday" +%Y-%m-%d).txt" ]; then
    diff "$REPORT_DIR/lynis-report-$(date -d "yesterday" +%Y-%m-%d).txt" "$REPORT" > "$DIFF_REPORT"
fi

# Parse and alert on critical findings
grep "Warning:" "$REPORT" | mail -s "Lynis Warnings - $DATE" security@example.com
```

#### Lynis Integration with Security Tools
```bash
# Integration with auditd
auditctl -w /usr/sbin/lynis -p x -k lynis_execution

# Integration with OSSEC
cat > /var/ossec/etc/ossec.conf << EOF
<localfile>
    <log_format>full_command</log_format>
    <command>lynis audit system --quick</command>
    <frequency>86400</frequency>
</localfile>
EOF
```

### Best Practices
1. Maintain accurate system baselines
2. Regular log rotation and archival
3. Document all investigative steps
4. Keep tools and signatures updated
5. Regular system updates and patches
6. Network segmentation and monitoring
7. Regular backup verification

Remember to adapt these procedures based on your specific environment and security requirements. Always follow your organization's security policies and procedures when conducting threat hunting activities.
